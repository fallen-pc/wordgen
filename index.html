<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Business/Personal Transfer Word Generators</title>
<meta name="theme-color" content="#10e580" />
<style>
  /* CRT‑green theme to match the provided logo */
  :root{
    --bg:#050c08;           /* near‑black */
    --card:#0a1410;         /* dark panel */
    --muted:#7aa690;        /* desaturated green */
    --border:#133326;       /* deep green border */
    --fg:#d2ffe7;           /* pale mint text */
    --accent:#10e580;       /* neon green accent */
    --accent-2:#0bd173;     /* hover variant */
    --biz:#0e271f;          /* business badge bg */
    --biz-br:#10e580;       /* business badge border */
    --per:#2c1030;          /* personal badge bg (complement) */
    --per-br:#b553d0;       /* personal badge border */
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,Segoe UI,Roboto,Arial,sans-serif;position:relative}
  /* soft scanline effect to echo the logo */
  body::before{content:"";position:fixed;inset:0;pointer-events:none;background:repeating-linear-gradient( to bottom, rgba(16,229,128,0.05), rgba(16,229,128,0.05) 1px, transparent 2px, transparent 3px)}
  body.splash-active header,
  body.splash-active main{display:none}
  #splash{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(5,12,8,0.92);backdrop-filter:blur(6px);z-index:1000;padding:24px}
  #splash.hidden{display:none}
  .splash-card{max-width:420px;width:100%;background:var(--card);border:1px solid var(--border);border-radius:18px;padding:32px 28px;box-shadow:0 0 30px rgba(16,229,128,.18);text-align:center;display:flex;flex-direction:column;align-items:center;gap:16px}
  .splash-logo, .logo{display:block;height:auto}
  .splash-logo{width:160px;animation:logoPulse 4s ease-in-out infinite;transform-origin:center;filter:drop-shadow(0 0 12px rgba(16,229,128,.45));}
  .splash-title{font-size:26px;margin:0;color:var(--fg)}
  .splash-copy{margin:0;color:var(--muted);font-size:15px}
  .splash-button{background:var(--accent);color:#041109;font-weight:600;padding:12px 24px;border-radius:999px;border:none;cursor:pointer;font-size:16px;box-shadow:0 0 12px rgba(16,229,128,.35)}
  .splash-button:hover{background:var(--accent-2)}

  @keyframes logoPulse{
    0%,100%{transform:scale(1);filter:drop-shadow(0 0 12px rgba(16,229,128,.45));}
    50%{transform:scale(1.05);filter:drop-shadow(0 0 18px rgba(16,229,128,.75));}
  }


  header{max-width:1000px;margin:32px auto 8px;padding:0 16px;display:flex;align-items:center;justify-content:space-between}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:120px;animation:logoPulse 6s ease-in-out infinite;transform-origin:center;filter:drop-shadow(0 0 8px rgba(16,229,128,.35));}
  h1{font-size:22px;margin:0}
  .muted{color:var(--muted)}

  main{max-width:1000px;margin:0 auto;padding:0 16px 48px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:16px 0}
  button{background:#0e1d17;border:1px solid var(--border);color:var(--fg);padding:10px 14px;border-radius:10px;cursor:pointer}
  button:hover{border-color:var(--accent);box-shadow:0 0 0 1px var(--accent);}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(360px,1fr));gap:16px}
  .card{position:relative;background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;display:flex;flex-direction:column;gap:12px;min-height:360px;box-shadow:0 0 0 1px rgba(16,229,128,.05)}
  .row{display:flex;gap:8px;align-items:center}
  input[type="text"], select{flex:1;background:#07140f;border:1px solid var(--border);color:var(--fg);padding:10px 12px;border-radius:10px;outline:none}
  input[type="text"]:focus, select:focus{border-color:var(--accent)}
  .word{font-size:24px;font-weight:700;min-height:30px}
  .pill{font-size:12px;background:#0c1d17;border:1px solid var(--border);padding:2px 8px;border-radius:999px;color:var(--muted)}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  .small{padding:6px 9px;font-size:13px}
  .sub{border:1px dashed rgba(16,229,128,.35);border-radius:12px;padding:10px}
  .sub h4{margin:0 0 6px 0;font-size:13px;color:#b9f8db;letter-spacing:.3px}
  .tag{font-size:11px;padding:2px 6px;border-radius:999px;border:1px solid rgba(16,229,128,.35);background:#08130f;color:#9beec9}
  .hint{font-size:12px;color:#9bd4bd}
  .close{position:absolute;top:8px;right:8px;line-height:1;border:1px solid var(--border);background:#07140f;border-radius:8px;padding:4px 8px;cursor:pointer;color:var(--fg);z-index:10;pointer-events:auto}
  .close:hover{border-color:var(--accent)}
  .badge{align-self:flex-start;padding:4px 10px;border-radius:999px;font-weight:600;border:1px solid}
  .badge.business{background:var(--biz);border-color:var(--biz-br);color:#b9f8db}
  .badge.personal{background:var(--per);border-color:var(--per-br)}
  .chooser{flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:12px;padding:16px;border:1px dashed rgba(16,229,128,.35);border-radius:12px;min-height:260px}
  .choices{display:flex;gap:12px;flex-wrap:wrap}
  .typeBtn{display:inline-block;min-width:140px;font-size:16px;padding:12px 16px;border-radius:12px}
  .typeBtn.business{background:rgba(16,229,128,.12);border:1px solid var(--accent);}
  .typeBtn.business:hover{background:rgba(16,229,128,.18)}
  .typeBtn.personal{background:rgba(181,83,208,.12);border:1px solid var(--per-br)}
  .placeholder{flex:1;display:flex;justify-content:center;align-items:center;border:1px dashed #503050;border-radius:12px;min-height:240px}
  .uc{font-size:14px;padding:8px 12px;border-radius:8px;border:1px solid #805080;background:#3a1d3a}
  #testout{white-space:pre-wrap;background:#07140f;border:1px solid var(--border);padding:10px;border-radius:10px;display:none}
  .ok{color:#8be28b} .fail{color:#ff8686}
</style>
</head>
<body class="splash-active">
  <div id="splash">
    <div class="splash-card">
      <img class="splash-logo" src="wordsgen.png" alt="WordGen logo" />
      <h2 class="splash-title">WordGen</h2>
      <p class="splash-copy">Generate business and personal transfer phrases with a retro CRT vibe.</p>
      <button id="enterApp" class="splash-button">Enter</button>
    </div>
  </div>

  <header>
    <div class="brand">
      <img class="logo" src="wordsgen.png" alt="WordGen logo" />
      <h1>Business / Personal Transfer Word Generators</h1>
    </div>
    <div class="muted">Pick Business or Personal per box. Business shows Incoming and Outgoing. Personal is under construction.</div>
  </header>
  <main>
    <div class="toolbar">
      <button id="addGen">Add generator</button>
      <button id="resetAll" class="small">Reset all</button>
      <button id="runTests" class="small">Run tests</button>
      <span class="pill" id="stats"></span>
    </div>
    <section id="grid" class="grid"></section>
    <pre id="testout" class="muted"></pre>
  </main>

<script type="module">

  const splash = document.getElementById('splash');
  const enterAppBtn = document.getElementById('enterApp');
  if(enterAppBtn && splash){
    enterAppBtn.addEventListener('click', ()=>{
      document.body.classList.remove('splash-active');
      splash.classList.add('hidden');
    });
  }

  // ────────────────────────────────────────────────────────────
  // Generic outgoing words (apply to all business types)
  const GENERIC_OUT = [
    'Payment','Transfer','Expenses','Fees','Supplies','Equipment','Subscription','Rent','Insurance','Reference No. XXXX','reference no XXXX','Ref XXXX','Reference number XXXX','Payment reference XXXX'
  ];

  // Business-specific outgoing words
  const OUT_WORDS_BY_BUSINESS = {
    'General': ['Stationery','Software','Travel','Fuel','Advertising'],
    'Sex Worker': ['Private booking','Escort service','Club fees','Condoms','Lingerie','Room hire','Security','Advertising'],
    'Landscaper': ['Lawn care','Mulch','Planting','Hedge trimming','Green waste disposal','Garden supplies','Equipment hire'],
    'Cleaner': ['Cleaning supplies','Detergents','Disinfectant','Window cleaning','Bond clean','Consumables','Laundry service'],
    'Hairdresser': ['Salon rent','Hair colour stock','Shampoo','Styling tools','Foils','Product restock','Appointment software'],
    'Massage Therapist': ['Massage oil','Table maintenance','Laundry service','Clinic rent','Professional indemnity','CPD training'],
    'Dog Walker': ['Leads and harnesses','Treats','Dog transport','Pet insurance','Dog park fees','Marketing flyers'],
    'Personal Trainer': ['Gym rent','Equipment purchase','Nutrition plans','Fitness software','Travel to client','Marketing'],
    'Freelance Photographer': ['Camera gear','Lens hire','Editing software','Studio hire','Printing','Travel shoot'],
    'Tutor': ['Learning materials','Printing notes','Online platform fees','Whiteboard supplies','Travel to student','Exam prep guides']
  };

  const GENERIC_INCOMING_TEMPLATES = [
    'Invoice {num}','Invoice no. {num}','Inv {num}','Invoice {num} paid in full','Payment made for inv {num}','PAYMENT INV {num}','Payment received inv {num}','Payment received for invoice {num}','Payment made for invoice {num}','Payment received - inv {num}'
  ];

  const INCOMING_TEMPLATES_BY_BUSINESS = {
    'General': ['Service payment for invoice {num}','Invoice {num} processed'],
    'Sex Worker': ['Session invoice {num} settled','Private booking payment inv {num}','Deposit received inv {num}'],
    'Landscaper': ['Garden service inv {num} paid','Lawn maintenance invoice {num} settled','Horticulture invoice {num} processed'],
    'Cleaner': ['Cleaning service inv {num} paid','End of lease invoice {num} settled','Domestic clean inv {num} processed'],
    'Hairdresser': ['Salon service invoice {num} settled','Colour package inv {num} paid','Hair appointment inv {num} processed'],
    'Massage Therapist': ['Treatment invoice {num} paid','Wellness session inv {num} settled','Clinic payment inv {num} processed'],
    'Dog Walker': ['Walk package inv {num} paid','Pet care invoice {num} settled','Canine service inv {num} processed'],
    'Personal Trainer': ['Training session inv {num} paid','Fitness program invoice {num} settled','Coaching inv {num} processed'],
    'Freelance Photographer': ['Shoot invoice {num} paid','Photo package inv {num} settled','Editing invoice {num} processed'],
    'Tutor': ['Lesson invoice {num} paid','Tutoring inv {num} settled','Session invoice {num} processed']
  };

  // Incoming uses auto-numbered invoice formats
  const INVOICE_FORMATS = [
    { id:'INV_NO_4',       width:4, pattern:'Invoice No {num}' },
    { id:'INV_HASH_4',     width:4, pattern:'Invoice #{num}' },
    { id:'INV_SIMPLE_4',   width:4, pattern:'Invoice {num}' },
    { id:'INV_NUMBER_7',   width:7, pattern:'Invoice Number {num}' },
    { id:'INV_CODE',       width:0, pattern:'INV {num}' },
    { id:'INV_DASH_5',     width:5, pattern:'INV-{num}' },
    { id:'TAX_INV_6',      width:6, pattern:'Tax Invoice {num}' },
    { id:'INV_NO_COLON_5', width:5, pattern:'Invoice No: {num}' }
  ];

  // Business types for dropdown
  const BUSINESS_TYPES = [
    'General','Sex Worker','Landscaper','Cleaner','Hairdresser','Massage Therapist','Dog Walker','Personal Trainer','Freelance Photographer','Tutor'
  ];

  // ────────────────────────────────────────────────────────────
  // Storage
  const KEY = 'btw_generators_v4';
  const read  = () => JSON.parse(localStorage.getItem(KEY) || '[]');
  const write = (arr) => { try { localStorage.setItem(KEY, JSON.stringify(arr)); } catch(e) { console.warn('localStorage write failed', e); } };

  // State
  let gens = read();
  const grid = document.getElementById('grid');
  const stats = document.getElementById('stats');

  // Helpers
  const safeUUID = () => (window.crypto && crypto.randomUUID ? crypto.randomUUID() : ('g-'+Date.now().toString(36)+Math.random().toString(36).slice(2,8)));
  const uniq = (arr) => [...new Set(arr)];
  const pick = (list) => list[Math.floor(Math.random()*list.length)];
  const randomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
  const randomDigits = (len=4) => Array.from({length:len}, () => Math.floor(Math.random()*10)).join('');
  const applyOutgoingTemplate = (word) => word ? word.replace(/[xX]{3,}/g, () => randomDigits(randomInt(4,8))) : word;
  const getOutWordList = (bizType) => uniq([ ...GENERIC_OUT, ...((OUT_WORDS_BY_BUSINESS[bizType])||[]) ]);
  const getIncomingTemplateList = (bizType) => uniq([ ...GENERIC_INCOMING_TEMPLATES, ...((INCOMING_TEMPLATES_BY_BUSINESS[bizType])||[]) ]);

  function ensureInvoiceState(g){
    if(!g.inv || typeof g.inv !== 'object'){
      const fmt = pick(INVOICE_FORMATS);
      const start = startNumber(fmt);
      g.inv = { fmtId: fmt.id, width: typeof fmt.width === 'number' ? fmt.width : 0, next: start, pending: [], skipCountdown: randomInt(5,10) };
      return;
    }
    const inv = g.inv;
    if(!inv.fmtId){
      const fmt = pick(INVOICE_FORMATS);
      inv.fmtId = fmt.id;
      if(typeof inv.width !== 'number') inv.width = typeof fmt.width === 'number' ? fmt.width : 0;
      if(typeof inv.next !== 'number' || !Number.isFinite(inv.next)) inv.next = startNumber(fmt);
    }
    if(typeof inv.width !== 'number'){
      const fmt = getFmtById(inv.fmtId);
      inv.width = fmt ? fmt.width : 0;
    }
    if(typeof inv.next !== 'number' || !Number.isFinite(inv.next)){
      const fmt = getFmtById(inv.fmtId);
      inv.next = startNumber(fmt);
    }
    inv.next = Math.max(1, Math.round(inv.next));
    if(!Array.isArray(inv.pending)){
      inv.pending = [];
    }
    if(typeof inv.skipCountdown !== 'number' || inv.skipCountdown < 1 || !Number.isFinite(inv.skipCountdown)){
      inv.skipCountdown = randomInt(5,10);
    }
  }

  function nextInvoiceNumber(inv){
    if(!Array.isArray(inv.pending)){
      inv.pending = [];
    }
    if(typeof inv.skipCountdown !== 'number' || inv.skipCountdown < 1 || !Number.isFinite(inv.skipCountdown)){
      inv.skipCountdown = randomInt(5,10);
    }
    if(inv.pending.length > 0){
      const shouldUsePending = inv.pending.length >= 3 || Math.random() < 0.5;
      if(shouldUsePending){
        return inv.pending.shift();
      }
    }
    const number = inv.next;
    inv.next = number + 1;
    inv.skipCountdown -= 1;
    if(inv.skipCountdown <= 0){
      const skipCount = randomInt(1,2);
      for(let i=0; i<skipCount; i++){
        inv.pending.push(inv.next);
        inv.next += 1;
      }
      inv.skipCountdown = randomInt(5,10);
    }
    return number;
  }

  function newGen(){
    return { id: safeUUID(), mode: null, name: '', bizType: 'General', lastOut: '', lastIn: '', inv: null };
  }

  function render(){
    grid.innerHTML='';
    gens.forEach(g => grid.appendChild(card(g)));
    stats.textContent = `${gens.length} boxes � generic words ${GENERIC_OUT.length} � incoming templates ${GENERIC_INCOMING_TEMPLATES.length}`;
  }

  function card(g){
    const el = document.createElement('div');
    el.className='card';
    el.dataset.id = g.id;

    // close (X)
    const close = document.createElement('button');
    close.className='close'; close.setAttribute('aria-label','Close'); close.textContent='×';
    close.onclick = (ev)=>{ ev.preventDefault(); if(confirm('Remove this box?')) removeGen(g.id); };

    // badge
    const badge = document.createElement('div');
    badge.className='badge ' + (g.mode==='business' ? 'business' : g.mode==='personal' ? 'personal' : '');
    badge.textContent = g.mode ? (g.mode==='business' ? 'BUSINESS' : 'PERSONAL') : 'SELECT TYPE';

    // if no mode yet, show chooser
    if(!g.mode || (g.mode!=='business' && g.mode!=='personal')){
      const chooser = document.createElement('div');
      chooser.className='chooser';
      const info = document.createElement('div'); info.className='muted'; info.textContent = 'Choose a box type';
      const row = document.createElement('div'); row.className='choices';
      const bBtn = document.createElement('button'); bBtn.className='typeBtn business'; bBtn.textContent='Business'; bBtn.type='button';
      const pBtn = document.createElement('button'); pBtn.className='typeBtn personal'; pBtn.textContent='Personal'; pBtn.type='button';
      bBtn.onclick = (ev)=>{
        ev.preventDefault();
        g.mode='business';
        if(!g.inv){ const fmt=pick(INVOICE_FORMATS); const start=startNumber(fmt); g.inv={fmtId:fmt.id,next:start}; }
        write(gens);
        // swap only this card to avoid full re-render flash
        const newEl = buildBusinessCard(g);
        grid.replaceChild(newEl, el);
      };
      pBtn.onclick = (ev)=>{ ev.preventDefault(); g.mode='personal'; write(gens); const newEl = buildPersonalCard(g); grid.replaceChild(newEl, el); };
      row.append(bBtn,pBtn);
      chooser.append(info,row);
      el.append(close, badge, chooser);
      return el;
    }

    // already has mode
    if(g.mode==='personal') return buildPersonalCard(g, el, close, badge);
    return buildBusinessCard(g, el, close, badge);
  }

  function buildPersonalCard(g, el, close, badge){
    el = el || document.createElement('div');
    el.className='card';
    el.dataset.id = g.id;
    close = close || (()=>{ const b=document.createElement('button'); b.className='close'; b.textContent='×'; b.onclick=(ev)=>{ ev.preventDefault(); if(!confirm('Remove this box?')){ ev.stopPropagation(); return; } removeGen(g.id); }; return b; })();
    badge = badge || (()=>{ const d=document.createElement('div'); d.className='badge personal'; d.textContent='PERSONAL'; return d; })();

    const nameRow = document.createElement('div'); nameRow.className='row';
    const name = document.createElement('input'); name.type='text'; name.placeholder='Generator name'; name.value=g.name||'';
    name.oninput = (e)=>{ g.name = e.target.value; write(gens); };

    const ph = document.createElement('div'); ph.className='placeholder';
    const uc = document.createElement('div'); uc.className='uc'; uc.textContent='Personal mode — under construction';
    ph.append(uc);

    nameRow.append(name);
    el.replaceChildren(close, badge, nameRow, ph);
    return el;
  }

  function buildBusinessCard(g, el, close, badge){
    el = el || document.createElement('div');
    el.className='card';
    el.dataset.id = g.id;
    close = close || (()=>{ const b=document.createElement('button'); b.className='close'; b.textContent='×'; b.onclick=(ev)=>{ ev.preventDefault(); if(!confirm('Remove this box?')){ ev.stopPropagation(); return; } removeGen(g.id); }; return b; })();
    badge = badge || (()=>{ const d=document.createElement('div'); d.className='badge business'; d.textContent='BUSINESS'; return d; })();

    // ensure invoice state exists (no write here to avoid re-render loops)
    ensureInvoiceState(g);

    const nameRow = document.createElement('div'); nameRow.className='row';
    const name = document.createElement('input'); name.type='text'; name.placeholder='Generator name'; name.value=g.name||'';
    name.oninput = (e)=>{ g.name = e.target.value; write(gens); };

    // business type row (dropdown)
    const bizRow = document.createElement('div'); bizRow.className='row';
    const select = document.createElement('select');
    BUSINESS_TYPES.forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; select.appendChild(o); });
    select.value = g.bizType || 'General';
    const bizHint = document.createElement('span'); bizHint.className='hint'; bizHint.textContent='Business type';

    // OUTGOING sub-box (depends on business type)
    const outBox = document.createElement('div'); outBox.className='sub';
    const outHeader = document.createElement('div'); outHeader.className='row';
    const outTitle = document.createElement('h4'); outTitle.textContent='Outgoing';
    const outTag = document.createElement('span'); outTag.className='tag'; outTag.textContent=`${getOutWordList(g.bizType).length} words`;
    outHeader.append(outTitle,outTag);
    const outWord = document.createElement('div'); outWord.className='word'; outWord.textContent=g.lastOut||'—';
    const outCtrls = document.createElement('div'); outCtrls.className='controls';
    const outGen = button('Generate', ()=>{ const list=getOutWordList(g.bizType); const choice = pick(list); setOut(g, outWord, applyOutgoingTemplate(choice)); });
    const outCopy = smallButton('Copy', async()=> copyText(g.lastOut, outCopy));
    outCtrls.append(outGen,outCopy);
    outBox.append(outHeader,outWord,outCtrls);

    // INCOMING sub-box
    const inBox = document.createElement('div'); inBox.className='sub';
    const inHeader = document.createElement('div'); inHeader.className='row';
    const inTitle = document.createElement('h4'); inTitle.textContent='Incoming (Invoice #)';
    const inTag = document.createElement('span'); inTag.className='tag'; inTag.textContent=`${getIncomingTemplateList(g.bizType).length} templates`;
    inHeader.append(inTitle,inTag);
    const inWord = document.createElement('div'); inWord.className='word'; inWord.textContent=g.lastIn||'-';
    const inCtrls = document.createElement('div'); inCtrls.className='controls';
    const inGen = button('Generate', ()=>{ generateInvoice(g, inWord); });
    const inCopy = smallButton('Copy', async()=> copyText(g.lastIn, inCopy));
    inCtrls.append(inGen,inCopy);
    inBox.append(inHeader,inWord,inCtrls);

    // respond to bizType change
    select.onchange = (e)=>{ g.bizType = e.target.value; write(gens); outTag.textContent = `${getOutWordList(g.bizType).length} words`; inTag.textContent = `${getIncomingTemplateList(g.bizType).length} templates`; };

    bizRow.append(select, bizHint);
    nameRow.append(name);
    el.replaceChildren(close, badge, nameRow, bizRow, outBox, inBox);
    return el;
  }

  function button(label, onClick){ const b=document.createElement('button'); b.textContent=label; b.onclick=onClick; b.type='button'; return b; }
  function smallButton(label, onClick){ const b=document.createElement('button'); b.className='small'; b.textContent=label; b.onclick=onClick; b.type='button'; return b; }
  async function copyText(text, btnEl){ if(!text) return; try{ await navigator.clipboard.writeText(text); const old=btnEl.textContent; btnEl.textContent='Copied'; setTimeout(()=>btnEl.textContent=old,900); }catch{} }

  // invoice helpers
  function getFmtById(id){ return INVOICE_FORMATS.find(f=>f.id===id) || INVOICE_FORMATS[0]; }
  function startNumber(fmt){
    const min = 50; // never below 50
    const max = fmt.width>0 ? Math.min(10**fmt.width - 1, 9999999) : 9999999;
    const span = Math.max(0, max - min);
    return min + Math.floor(Math.random()*(span+1));
  }
  function formatInvoice(fmtOrPattern, n, widthOverride){
    const isString = typeof fmtOrPattern === 'string';
    const pattern = isString ? fmtOrPattern : (fmtOrPattern && fmtOrPattern.pattern) || '{num}';
    const widthSource = !isString && fmtOrPattern && typeof fmtOrPattern.width === 'number' ? fmtOrPattern.width : 0;
    const width = typeof widthOverride === 'number' ? widthOverride : widthSource;
    const num = width > 0 ? String(n).padStart(width,'0') : String(n);
    return pattern.replace(/\{num\}/gi, num);
  }
  function generateInvoice(g, el){
    ensureInvoiceState(g);
    const inv = g.inv;
    const bizType = g.bizType || 'General';
    const templates = getIncomingTemplateList(bizType);
    const template = templates.length ? pick(templates) : 'Invoice {num}';
    const number = nextInvoiceNumber(inv);
    const fmt = inv.fmtId ? getFmtById(inv.fmtId) : null;
    const width = typeof inv.width === 'number' ? inv.width : (fmt && typeof fmt.width === 'number' ? fmt.width : 0);
    if(typeof inv.width !== 'number') inv.width = width;
    const textValue = formatInvoice(template, number, width);
    g.lastIn = textValue;
    el.textContent = textValue;
    write(gens);
  }
  function setOut(g, el, val){ g.lastOut = val; el.textContent = val; write(gens); }

  // CRUD
  function addGen(){ gens.push(newGen()); write(gens); render(); }
  function removeGen(id){ gens = gens.filter(x=>x.id!==id); write(gens); render(); }

  // Toolbar
  document.getElementById('addGen').onclick = (ev)=>{ ev.preventDefault(); addGen(); };
  document.getElementById('resetAll').onclick = (ev)=>{ ev.preventDefault(); if(confirm('Reset all boxes?')){ gens=[newGen()]; write(gens); render(); } };

  // Delegated close handler for robustness
  grid.addEventListener('click', (ev)=>{
    const btn = ev.target.closest('.close');
    if(!btn) return;
    ev.preventDefault();
    const cardEl = btn.closest('.card');
    const id = cardEl && cardEl.dataset.id;
    if(id && confirm('Remove this box?')) removeGen(id);
  });

  // ────────────────────────────────────────────────────────────
  // Tests
  document.getElementById('runTests').onclick = runTests;
  const testOut = document.getElementById('testout');
  function assert(cond, msg){ if(!cond) throw new Error(msg); }

  function runTests(){
    const lines = [];
    const pass = (m)=>lines.push(`✔ ${m}`);
    const fail = (m,e)=>lines.push(`✘ ${m}: ${e.message}`);
    const tryTest = (name, fn)=>{ try{ fn(); pass(name); } catch(e){ fail(name,e); } };

    tryTest('new box starts in select mode', ()=>{ const g = newGen(); assert(g.mode===null, 'mode should start null'); });
    tryTest('invalid mode falls back to chooser', ()=>{ const g=newGen(); g.mode='weird'; const el=card(g); const hasChooser=!!el.querySelector('.choices'); assert(hasChooser,'chooser not shown for invalid mode'); });
    tryTest('choosing Business sets mode and seeds inv', ()=>{ const g = newGen(); g.mode='business'; ensureInvoiceState(g); assert(g.mode==='business','mode not business'); assert(g.inv && g.inv.fmtId,'inv not seeded'); assert(g.inv.next>=50,'start < 50'); assert(Array.isArray(g.inv.pending),'pending not array'); assert(typeof g.inv.skipCountdown === 'number','skip countdown missing'); });
    tryTest('choosing Personal sets mode and placeholder', ()=>{ const g = newGen(); g.mode='personal'; write([g]); const el = card(g); assert(el.querySelector('.placeholder'),'no placeholder for personal'); assert(el.querySelector('.badge').textContent==='PERSONAL','badge not personal'); });
    tryTest('startNumber() never below 50', ()=>{ for(const fmt of INVOICE_FORMATS){ for(let i=0;i<20;i++){ const n=startNumber(fmt); assert(n>=50, `got ${n} for ${fmt.id}`); } } });
    tryTest('startNumber() respects width', ()=>{ for(const fmt of INVOICE_FORMATS){ if(fmt.width>0){ for(let i=0;i<10;i++){ const n=startNumber(fmt); const max=10**fmt.width-1; assert(n<=max, `n ${n} > ${max}`); } } } });
    tryTest('format padding/no padding', ()=>{ const f={id:'W4',width:4,pattern:'Invoice {num}'}; assert(formatInvoice(f,52)==='Invoice 0052','pad fail'); const f0={id:'W0',width:0,pattern:'INV {num}'}; assert(formatInvoice(f0,52)==='INV 52','nopad fail'); });
    tryTest('generateInvoice queues and replays skipped numbers', ()=>{ const g=newGen(); g.mode='business'; ensureInvoiceState(g); const el=document.createElement('div'); g.inv.skipCountdown = 1; const firstExpected = g.inv.next; generateInvoice(g,el); const formattedFirst = formatInvoice('{num}', firstExpected, g.inv.width); assert(g.lastIn.includes(formattedFirst),'first number missing'); assert(g.inv.pending.length>=1,'pending queue not created'); const forced = g.inv.pending[0]; while(g.inv.pending.length<3){ g.inv.pending.push(g.inv.next); g.inv.next += 1; } g.inv.skipCountdown = 5; const beforeQueueSize = g.inv.pending.length; generateInvoice(g,el); const formattedForced = formatInvoice('{num}', forced, g.inv.width); assert(g.lastIn.includes(formattedForced),'pending number not used'); assert(g.inv.pending.length === beforeQueueSize-1,'pending length not reduced'); assert(!g.inv.pending.includes(forced),'pending number still present'); });
    tryTest('business tag count updates on bizType change', ()=>{ const g=newGen(); g.mode='business'; const el=card(g); const select=el.querySelector('select'); const tags=el.querySelectorAll('.tag'); const outTag=tags[0]; const inTag=tags[1]; const beforeOut=outTag.textContent; const beforeIn=inTag.textContent; select.value='Landscaper'; select.dispatchEvent(new Event('change')); const afterOut=outTag.textContent; const afterIn=inTag.textContent; assert(beforeOut!==afterOut,'out tag unchanged'); assert(beforeIn!==afterIn,'in tag unchanged'); });
    tryTest('removeGen removes exactly one item', ()=>{ const prev = gens.length; const g = newGen(); gens.push(g); write(gens); removeGen(g.id); if(gens.length !== prev){ throw new Error(`expected length ${prev} got ${gens.length}`); } });
    tryTest('outgoing XXXX placeholder replaced', ()=>{ const samples = [applyOutgoingTemplate('PAY INVOICE NO XXXX'), applyOutgoingTemplate('reference no xxxx'), applyOutgoingTemplate('Ref XXXX')]; samples.forEach((sample, idx)=>{ const match = sample.match(/\d+/); if(!match) throw new Error(`digits missing in sample ${idx}`); const len = match[0].length; if(len < 4 || len > 8) throw new Error(`digits length ${len} out of range`); }); });
    tryTest('outgoing list mixes generic and business-specific', ()=>{ const list = getOutWordList('Landscaper'); if(!list.includes('Mulch')) throw new Error('Mulch missing'); if(!list.includes('Equipment hire')) throw new Error('Equipment hire missing'); const general = getOutWordList('General'); if(general.includes('Mulch')) throw new Error('Landscaper word leaked into General'); });

    tryTest('incoming template list adapts to biz type', ()=>{ const general = getIncomingTemplateList('General'); const hair = getIncomingTemplateList('Hairdresser'); assert(hair.length>general.length,'hairdresser templates not added'); const hasHair = hair.some(t=>/hair/i.test(t)); assert(hasHair,'hairdresser phrase missing'); });

    testOut.textContent = lines.join('\n');
    testOut.style.display = 'block';
    testOut.className = lines.some(l=>l.startsWith('✘')) ? 'fail' : 'ok';
  }

  // Bootstrap
  if (gens.length===0){ gens=[newGen()]; write(gens); }
  render();
</script>
</body>
</html>
